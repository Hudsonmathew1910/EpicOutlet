{% extends "shop/layouts/main.html" %}


{% block title %}
Products | EpicOutlet
{% endblock title %}

{% block content %}
<section class="py-4 my-5" style="background-color :#C9D6DF; min-height: 600px;">
  <div class="container">
    <div class="row">
      <div class="col-12">
          {% include "shop/inc/message.html" %}
          <h4 class="mb-3"> {{product}} </h4>
          <hr style="border-color: #b8bfc2;">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a class="text-decoration-none" href="{% url "home" %}">Home</a></li>
              <li class="breadcrumb-item"><a class="text-decoration-none" href="{% url "collection_view" product.catagory.name %}">Collection</a></li>
              <li class="breadcrumb-item active" aria-current="page">{{product.name}}</li>
            </ol>
          </nav>
        </div>
        <div class="col-4 my-3  pic-box">
          {% if product.Trending %}
          <div class="hot"><i class="fa fa-fire"></i> HOT</div>
          {% endif %}
          <img src="{{product.product_image.url}}" class="card-img-top pro-img" alt="{{product}}">
        </div>
        <div class="col-4 my-3">
          <h4 class="text-success he2">{{ product.name | upper }}</h4>
          <p class="he2"> {{ product.vendor}}</p>
          <p>{{ product.description }}</p>
          <h6 class="my-2">Orginal Price: Rs. <s>{{ product.orginal_price}}</s></h6>
          <h5 class="my-2 pro-pri">Offer Price : Rs. {{ product.selling_price}} </h5>
          {% if product.quantity > 0 %}
          <input type="hidden" value="{{ product.id }}" id="pid">
          {% csrf_token %}
          <p>
            <div class="btn-group" role="group" style="width: 130px;">
              <button type="button" class="btn btn-warning" id="minus"><i class="fa fa-minus"></i></button>
              <input type="text" name="qty" id="txtQty" value="1" class="form-control btn" style="text-align: center; background: #F0F5F9;">
              <button type="button" class="btn btn-warning" id="plus"><i class="fa fa-plus"></i></button>
            </div>
          </p>
          <button type="button" class="btn btn-light addto me-2" data-bs-toggle="modal" data-bs-target="#exampleModal"><i class="fa fa-shopping-cart"></i> Cart</button>
          {% else %}
          <button type="button" id="outst" class="btn btn-warning me-2" title="This product is currently out of stock"><i class="fa fa-minus"></i> Out of Stock</button>
          <script>
            document.addEventListener('DOMContentLoaded', function(event) {
              const outst = document.getElementById('outst');
              if (outst) {
                outst.addEventListener("click", function() {
                  alert("This product is currently out of stock");
                });
              }
            });
          </script>
          {% endif %}
          <button type="button" class="btn btn-secondary pro-but" id="btnfav"><i class="fa fa-thumbs-up"></i> Favourite </button>
        </div>
      </div> 
  </div>
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="background-color: #1E2022; color: #F0F5F9;">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">{{ product.name }}</h1>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-center">
        <div class="">Total Price: â‚¹ <span id="totalPrice">{{ product.selling_price }}</span></div> 
        <div class=>Total Quantity: <span id="checkqty">1</span></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="btcart">Add to Cart</button>
      </div>
    </div>
  </div>
</div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function(event){
   const minusBtn = document.getElementById('minus');
   const plusBtn = document.getElementById('plus');
   const qtyInput = document.getElementById('txtQty'); 
   const checkqty = document.getElementById('checkqty')
   const pid = document.getElementById('pid');
   const tkn = document.querySelector('[name=csrfmiddlewaretoken]').value;
   const btncart = document.getElementById('btcart');
   const outst = document.getElementById('outst');
   //const btncart = document.getElementById('btcart');
   const modalEl = document.getElementById('exampleModal');
   const bootstrapModal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
   const fav = document.getElementById('btnfav');
   
   function total(){
     let qty = parseInt(qtyInput.value, 10);
     qty = isNaN(qty) ? 0 : qty;
     checkqty.textContent = qty;
     document.getElementById('totalPrice').textContent = qty * {{ product.selling_price }};
    }
    
   plusBtn.addEventListener('click', function(){
    let qty = parseInt(qtyInput.value,10);
    qty=isNaN(qty)?0:qty;
    //console.log(qty);
    if(qty<10){
      qty++;
      qtyInput.value=qty;
      total();
    }
    console.log("Quantity after +:", qty);
    checkqty.textContent=qty;
   })

   minusBtn.addEventListener('click', function(){
    let qty=parseInt(qtyInput.value,10);
    qty=isNaN(qty)?0:qty;
    if(qty>1){
      qty--;
      qtyInput.value=qty;
      total();
    }
    console.log("Quantity after -:", qty);
    checkqty.textContent=qty;
   })

   btncart.addEventListener('click', function(){
    let qty=parseInt(qtyInput.value,10);
    qty=isNaN(qty)?0:qty;
    if(qty>0){
      let postobj = {
        product_qty: qty,
        pid: pid.value,
        //token: tkn
      }
      console.log("Cart object:", postobj);
      //console.log(postobj);
      fetch('/add-to-cart', {
        method: 'POST',
        credentials: 'same-origin',
        headers:{
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(postobj)
      }).then(response => {
        return response.json();
      }).then(data => {
      //console.log(data);
      alert(data['status']);
      bootstrapModal.hide();
      })
    }
    else{
      alert("Quantity must be at least 1");
    }
   })

   fav.addEventListener('click', function(){
      let postobj = {
        pid: pid.value,
      }
      console.log("Cart object:", postobj);
      //console.log(postobj);
      fetch('/fav', {
        method: 'POST',
        credentials: 'same-origin',
        headers:{
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(postobj)
      }).then(response => {
        return response.json();
      }).then(data => {
      //console.log(data);
      alert(data['status']);
      bootstrapModal.hide();
      })
    });
   console.log("JS loaded and working!");
  });
</script>
{% endblock content %}
